<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta http-equiv="pragma" content="no-cache">
	<!-- HTTP 1.0 -->
	<meta http-equiv="cache-control" content="no-cache">
	<!-- Prevent caching at the proxy server -->
	<meta http-equiv="expires" content="0">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	<title>作业中</title>
	<link href="../css/mui.min.css" rel="stylesheet" />
	<link rel="stylesheet" type="text/css" href="../css/icons-extra.css" />
	<link href="../css/common.css" rel="stylesheet"  />
	<style>
		div.mui-row {
			text-align: center;
			padding: 5px;
		}
		div.tableList .mui-row {
			border-bottom: 1px solid;
		}
		div.warnCount {
			font-size: 14px;
			color: #fff;
			background: #dd524d;
		}
		span.countNum {
			font-size: 13px;
		}
		h3 {
			font-size: 32px;
		}
		.mui-card .mui-control-content {
			padding: 10px;
		}
		.mui-control-content {
			height: 250px;
		}
		.mui-scroll{
			height: 100%;
		}
		.mui-table-view{
			height: 100%;
			overflow: auto;
		}
		#segmentedControl {
			font-size: 14px;
		}
		span.todo {
			background: #dd524d;
			padding: 8px;
			border-radius: 15px;
			color: #fff;
		}
		span.do {
			background: #3299fe;
			padding: 8px;
			border-radius: 15px;
			color: #fff;
		}
		.mui-navigate-right:after, .mui-push-right:after{
			right: 5px;
		}
		.yujingname {
			display: inline-block;
			text-overflow: ellipsis;
			overflow: hidden;
			white-space: nowrap;
		}
	</style>
</head>

<body>
<header class="mui-bar mui-bar-nav">
	<div class="mui-row" style="padding:0;">
			<div class="mui-col-sm-2 mui-col-xs-2" id="topBackList">
					<span class="vam mui-icon mui-icon-back "></span>
					<span class="vam mf5 ">返回</span>
			</div>
		<div class="mui-col-sm-8 mui-col-xs-8">
			<h1 class="mui-title"> 作业中 </h1>
		</div>
	</div>
</header>
<div class="mui-content">
	<ul class="mui-table-view first-task-ul"></ul>
	<div class="warnCount">
		<div class="mui-row">
			<div class="mui-col-sm-6 mui-col-xs-6">
				<div class="mui-col-sm-12 mui-col-xs-12">
					<span class="countNum">当前预警</span>
				</div>
				<div class="mui-col-sm-12 mui-col-xs-12">
					<h3 class="curWarning">--</h3>
				</div>
			</div>
			<div class="mui-col-sm-6 mui-col-xs-6">
				<div class="mui-col-sm-12 mui-col-xs-12">
					<span class="countNum">其中三级预警</span>
				</div>
				<div class="mui-col-sm-12 mui-col-xs-12">
					<h3 class="threeWarning">--</h3>
				</div>
			</div>
		</div>
	</div>
	<div style="padding: 10px 10px;">
		<div id="segmentedControl" class="mui-segmented-control">
			<a class="mui-control-item mui-active level_1" href="#item1">三级预警</a>
			<a class="mui-control-item level_2" href="#item2">二级预警</a>
			<a class="mui-control-item level_3" href="#item3">一级预警</a>
		</div>
	</div>
	<div class="typeList">
		<div id="item1" class="mui-control-content mui-active">
			<div id="scroll" class="mui-scroll-wrapper">
				<div class="mui-scroll">
					<ul class="mui-table-view">
						<!--<li class="mui-table-view-cell">-->
							<!--<a class="mui-navigate-right" onclick="toDetail(event)">-->
								<!--<div class="mui-row">-->
									<!--<div class="mui-col-sm-8 mui-col-xs-8">张三</div>-->
									<!--<div class="mui-col-sm-4 mui-col-xs-4">-->
										<!--<span class="todo">-->
											<!--待处理-->
										<!--</span>-->
									<!--</div>-->
								<!--</div>-->
								<!--<div class="mui-row">-->
									<!--<div class="mui-col-sm-12 mui-col-xs-12">2019-08-08 16:00:01</div>-->
								<!--</div>-->
							<!--</a>-->
						<!--</li>-->
						<!--<li class="mui-table-view-cell">-->
							<!--<a class="mui-navigate-right" onclick="toDetail(event)">-->
								<!--<div class="mui-row">-->
									<!--<div class="mui-col-sm-8 mui-col-xs-8">张三</div>-->
									<!--<div class="mui-col-sm-4 mui-col-xs-4">-->
										<!--<span class="do">-->
											<!--已处理-->
										<!--</span>-->
									<!--</div>-->
								<!--</div>-->
								<!--<div class="mui-row">-->
									<!--<div class="mui-col-sm-12 mui-col-xs-12">2019-08-08 16:00:01</div>-->
								<!--</div>-->
							<!--</a>-->
						<!--</li>-->
					</ul>
				</div>
			</div>
		</div>
		<div id="item2" class="mui-control-content">
			<ul class="mui-table-view"></ul>
		</div>
		<div id="item3" class="mui-control-content">
			<ul class="mui-table-view"></ul>
		</div>
	</div>

	<div class="rec-btn">
		<button id="isSure" type="button" data-loading-text="准备结束中..." data-loading-icon="mui-spinner mui-spinner-custom" class="mui-btn mui-btn-primary">
			作业准备结束
		</button>
	</div>

</div>
<script src="../js/mui.min.js"></script>
<script src="../js/common.js"></script>
<script src="../js/jquery.min.js"></script>
<script src="../js/addbottom.js"></script>
<script type="text/javascript" charset="utf-8">
    (function($) {
        var segmentedControl = document.getElementById('segmentedControl');
        var style = 'inverted';
        var color = 'negative';
        segmentedControl.className = 'mui-segmented-control' + (style ? (' mui-segmented-control-' + style) : '') + ' mui-segmented-control-' + color;
    })(mui);
    getDetailAfter();
    /*获取预警列表信息*/
    mui.ajax(httpUrl+'/task/getWaringReception',{
        data:{
            // num:'201908C0817',
            num:GetQueryString('num'),
            userId:'',
	        queryType:'person',
        },
        dataType:'json',//服务器返回json格式数据
        type:'post',//HTTP请求类型
        timeout:10000,//超时时间设置为10秒；
        headers:{'Content-Type':'application/json'},
        success:function(res){
            if(res.code === 0){
                var curData = res.data.data;
                var arr_1 = [];
                var arr_2 = [];
                var arr_3 = [];
                for( var i = 0;i<curData.length;i++ ) {
                    $('.curWarning').text(res.data.count);
                    if (curData[i].record.status === '0'){
                        curData[i].record.status = '待处理';
                        curData[i].record.status_ = 'todo';
                    } else if (curData[i].record.status === '1') {
                        curData[i].record.status = '已处理';
                        curData[i].record.status_ = 'do';
                    }
                    var waringNum = curData[i].record.waringNum;
                    var userId = curData[i].record.userId;
                    if(curData[i].record.level === '3') {
                        arr_1.push(curData[i]);
                        var str_1 = '<li class="mui-table-view-cell">' +
	                                  '<a class="mui-navigate-right" id="level_1'+ i +'" waringNum="'+waringNum+'" userId="'+userId+'" onclick="toDetail(event)">' +
			                             '<div class="mui-row">' +
			                                '<div class="mui-col-sm-9 mui-col-xs-9 yujingname" style="text-align: left">' + (curData[i].record.message || '--')+
			                                '</div>' +
				                            '<div class="mui-col-sm-3 mui-col-xs-3" style="text-align: right">' +
					                            '<span class=" '+curData[i].record.status_+' ">' + curData[i].record.status +
					                            '</span>' +
				                            '</div>' +
			                             '</div>' +
			                          '</a>' +
	                              '</li>';
                        $('#item1 .mui-table-view').append(str_1);

                    } else if (curData[i].record.level === '2') {
                        arr_2.push(curData[i]);
                        var str_2 = '<li class="mui-table-view-cell">' +
                            '<a class="mui-navigate-right" id="level_2'+ i +'" waringNum="'+waringNum+'" userId="'+userId+'" onclick="toDetail(event)">' +
                            '<div class="mui-row">' +
                            '<div class="mui-col-sm-9 mui-col-xs-9 yujingname" style="text-align: left">' + (curData[i].record.message||'--') +
                            '</div>' +
                            '<div class="mui-col-sm-3 mui-col-xs-3" style="text-align: right">' +
                            '<span class=" '+curData[i].record.status_+' ">' + curData[i].record.status +
                            '</span>' +
                            '</div>' +
                            '</div>' +
                            '</div>' +
                            '</a>' +
                            '</li>';
                        $('#item2 .mui-table-view').append(str_2);

                    } else if (curData[i].record.level === '1') {
                        arr_3.push(curData[i]);
                        var str_3 = '<li class="mui-table-view-cell">' +
                            '<a class="mui-navigate-right" id="level_3'+ i +'" waringNum="'+waringNum+'" userId="'+userId+'" onclick="toDetail(event)">' +
                            '<div class="mui-row">' +
                            '<div class="mui-col-sm-9 mui-col-xs-9 yujingname" style="text-align: left">' + (curData[i].record.message||'--') +
                            '</div>' +
                            '<div class="mui-col-sm-3 mui-col-xs-3" style="text-align: right">' +
                            '<span class=" '+curData[i].record.status_+' ">' + curData[i].record.status +
                            '</span>' +
                            '</div>' +
                            '</div>' +
                            '</div>' +
                            '</a>' +
                            '</li>';
                        $('#item3 .mui-table-view').append(str_3);
                    }
                }
                $('.level_1').text('三级预警(' + arr_1.length + ')');
                $('.level_2').text('二级预警(' + arr_2.length + ')');
                $('.level_3').text('一级预警(' + arr_3.length + ')');
                $('.threeWarning').text(arr_1.length);

            }
        },
        error:function(xhr,type,errorThrown) {
            //异常处理；
            console.log(type);
        }
    });

    document.getElementById('isSure').addEventListener('tap', function() {

        mui.confirm( userInfo.name +'，您于' + getNowDate() + '确认'+taskName+'作业准备结束，您确定吗？','',['确定','取消'],function(a){
            if (a.index === 0) {
				/*AI预警确认处理接口*/
                mui.ajax(httpUrl+'/task/working',{
                    data:{
                        username: userInfo.username,
                        command: "readyToEnd",
                        num: GetQueryString('num'),
                        gps: nowlocation,
                    },
                    dataType:'json',//服务器返回json格式数据
                    type:'post',//HTTP请求类型
                    timeout:10000,//超时时间设置为10秒；
                    headers:{'Content-Type':'application/json'},
                    success:function(res){
                        if(res.code === 0){
                            //确认成功后跳转
							if(ws){
								ws.close()
							}
                            mui.openWindow({
								url: `AIEndRemind.html?num=${GetQueryString('num')}`, /*作业准备结束页*/
								createNew: true,
								styles: {
									cachemode:"noCache",
								}
							});
                        }
                    },
                    error:function(xhr,type,errorThrown){
                        //异常处理；
                        console.log(type);
                    }
                });
            } else if (a.index === 1 ) {

            }
        })

    });

    function toDetail(event) {
        var waringNum =  $('#'+ event.currentTarget.id).attr('waringNum');
        var userId =  $('#'+ event.currentTarget.id).attr('userId');
        console.log(waringNum);
        console.log(userId);
	    localStorage.setItem('warnDetail',JSON.stringify({
		    "username":userId,
		    "waringNum":waringNum
	    }));
        mui.openWindow({
			url: `warningDetail.html?num=${GetQueryString('num')}`, /*预警详情页*/
			createNew: true,
			styles: {
				cachemode:"noCache",
			}
        })
    }
   
	var wsurl = 'ws'+ httpUrl.slice(4) + '/websocket/person'
    //判断当前浏览器是否支持WebSocket
    if ('WebSocket' in window) {
        ws = new WebSocket(wsurl)
    }
    else {
		mui.toast('当前浏览器 Not support websocket')
	}
	ws.onopen = function(){};
	ws.onmessage = function(evt){
		// console.log(evt.data)
		if(evt.data){
			var eventData = JSON.parse(evt.data) || {}
			var curData = eventData.data.data || [];
			$('#item1 .mui-table-view').html('')
			$('#item2 .mui-table-view').html('')
			$('#item3 .mui-table-view').html('')
			$('.curWarning').text(eventData.data.count);
			var arr_1 = [];
			var arr_2 = [];
			var arr_3 = [];
			for( var i = 0;i<curData.length;i++ ) {
				
				if (curData[i].record.status === '0'){
					curData[i].record.status = '待处理';
					curData[i].record.status_ = 'todo';
				} else if (curData[i].record.status === '1') {
					curData[i].record.status = '已处理';
					curData[i].record.status_ = 'do';
				}
				var waringNum = curData[i].record.waringNum;
				var userId = curData[i].record.userId;
				if(curData[i].record.level === '1') {
					arr_1.push(curData[i]);
					var str_1 = '<li class="mui-table-view-cell">' +
									'<a class="mui-navigate-right" id="level_1'+ i +'" waringNum="'+waringNum+'" userId="'+userId+'" onclick="toDetail(event)">' +
										'<div class="mui-row">' +
										'<div class="mui-col-sm-9 mui-col-xs-9 yujingname" style="text-align: left">' + (curData[i].record.message || '--')+
										'</div>' +
										'<div class="mui-col-sm-3 mui-col-xs-3" style="text-align: right">' +
											'<span class=" '+curData[i].record.status_+' ">' + curData[i].record.status +
											'</span>' +
										'</div>' +
										'</div>' +
									'</a>' +
								'</li>';
					$('#item1 .mui-table-view').append(str_1);

				} else if (curData[i].record.level === '2') {
					arr_2.push(curData[i]);
					var str_2 = '<li class="mui-table-view-cell">' +
						'<a class="mui-navigate-right" id="level_2'+ i +'" waringNum="'+waringNum+'" userId="'+userId+'" onclick="toDetail(event)">' +
						'<div class="mui-row">' +
						'<div class="mui-col-sm-9 mui-col-xs-9 yujingname" style="text-align: left">' + (curData[i].record.message||'--') +
						'</div>' +
						'<div class="mui-col-sm-3 mui-col-xs-3" style="text-align: right">' +
						'<span class=" '+curData[i].record.status_+' ">' + curData[i].record.status +
						'</span>' +
						'</div>' +
						'</div>' +
						'</div>' +
						'</a>' +
						'</li>';
					$('#item2 .mui-table-view').append(str_2);

				} else if (curData[i].record.level === '3') {
					arr_3.push(curData[i]);
					var str_3 = '<li class="mui-table-view-cell">' +
						'<a class="mui-navigate-right" id="level_3'+ i +'" waringNum="'+waringNum+'" userId="'+userId+'" onclick="toDetail(event)">' +
						'<div class="mui-row">' +
						'<div class="mui-col-sm-9 mui-col-xs-9 yujingname" style="text-align: left">' + (curData[i].record.message||'--') +
						'</div>' +
						'<div class="mui-col-sm-3 mui-col-xs-3" style="text-align: right">' +
						'<span class=" '+curData[i].record.status_+' ">' + curData[i].record.status +
						'</span>' +
						'</div>' +
						'</div>' +
						'</div>' +
						'</a>' +
						'</li>';
					$('#item3 .mui-table-view').append(str_3);
				}
			}
			$('.level_1').text('一级预警(' + arr_1.length + ')');
			$('.level_2').text('二级预警(' + arr_2.length + ')');
			$('.level_3').text('三级预警(' + arr_3.length + ')');
			$('.threeWarning').text(arr_3.length);
		

	    }
	};
	ws.onerror = function () {
        mui.toast("连接发生错误");
    }
	
</script>

</body>

</html>